<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FALLOUT: New Nova Scotia - PLAYER</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --pip-green: #1aff80;
            --pip-bg: #0c160c;
            --pip-dark: #050a05;
            --pip-rad: #ffcf1a;
            --pip-health: #ff1a1a;
        }
        body {
            background-color: var(--pip-bg);
            color: var(--pip-green);
            font-family: 'Share Tech Mono', monospace;
            text-transform: uppercase;
            user-select: none;
        }
        .pip-border {
            border: 2px solid var(--pip-green);
            box-shadow: 0 0 10px rgba(26, 255, 128, 0.2);
        }
        .pip-btn {
            background-color: var(--pip-dark);
            border: 1px solid var(--pip-green);
            color: var(--pip-green);
            cursor: pointer;
            padding: 8px 12px;
            transition: all 0.2s;
        }
        .pip-btn:hover {
            background-color: var(--pip-green);
            color: var(--pip-dark);
        }
        .crt-scanline {
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 100;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .stat-bar { height: 8px; background: #111; border: 1px solid var(--pip-green); overflow: hidden; }
        .stat-fill { height: 100%; background: var(--pip-green); transition: width 0.3s; }
        .health-fill { background: var(--pip-health); }
        .rad-fill { background: var(--pip-rad); }
        .quest-card {
            border: 1px solid var(--pip-green);
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(0,0,0,0.4);
        }
        .radio-alert {
            border-left: 3px solid var(--pip-rad);
            background: rgba(255, 207, 26, 0.1);
            padding: 10px;
            margin-bottom: 8px;
        }
    </style>
</head>
<body class="p-4 max-w-lg mx-auto pb-24">
    <div class="crt-scanline"></div>

    <!-- HEADER -->
    <header class="mb-6 pip-border p-4 bg-black">
        <div class="flex justify-between items-center">
            <div>
                <h1 id="player-name" class="text-2xl font-bold">PLAYER</h1>
                <p class="text-[10px] opacity-70">PIP-BOY CONNECTED</p>
            </div>
            <div class="text-right">
                <p id="sync-status" class="text-[8px] text-yellow-500">SYNCING...</p>
            </div>
        </div>
    </header>

    <!-- NAVIGATION -->
    <nav class="grid grid-cols-7 gap-1 mb-6">
        <button onclick="showTab('status')" class="pip-btn p-2 text-[9px]">STATUS</button>
        <button onclick="showTab('perks')" class="pip-btn p-2 text-[9px]">PERK</button>
        <button onclick="showTab('quests')" class="pip-btn p-2 text-[9px]">QUESTS</button>
        <button onclick="showTab('daily')" class="pip-btn p-2 text-[9px]">DAILY</button>
        <button onclick="showTab('crafting')" class="pip-btn p-2 text-[9px]">CRAFT</button>
        <button onclick="showTab('quarters')" class="pip-btn p-2 text-[9px]">QUARTERS</button>
        <button onclick="showTab('radio')" class="pip-btn p-2 text-[9px]">RADIO</button>
    </nav>

    <!-- TAB: STATUS -->
    <section id="status" class="tab-content active">
        <div class="space-y-4">
            <!-- CHARACTER INFO -->
            <div class="pip-border p-4 bg-black/50">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 id="display-class" class="text-xl">CLASS</h2>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px]">LEVEL</p>
                        <p id="display-level" class="text-2xl font-bold">1</p>
                    </div>
                </div>
                
                <!-- VITALS -->
                <div class="space-y-2">
                    <div>
                        <div class="flex justify-between text-[10px]"><span>HP</span><span id="hp-val">10/10</span></div>
                        <div class="stat-bar"><div id="hp-bar" class="stat-fill health-fill" style="width: 100%"></div></div>
                    </div>
                    <div>
                        <div class="flex justify-between text-[10px]"><span>RADS</span><span id="rad-val">0/10</span></div>
                        <div class="stat-bar"><div id="rad-bar" class="stat-fill rad-fill" style="width: 0%"></div></div>
                    </div>
                </div>
            </div>

            <!-- RESOURCES -->
            <div class="grid grid-cols-2 gap-4">
                <div class="pip-border p-3 bg-black/50">
                    <p class="text-xs mb-1">CAPS (TABS)</p>
                    <p id="display-tabs" class="text-3xl font-bold">10</p>
                </div>
                <div class="pip-border p-3 bg-black/50">
                    <p class="text-xs mb-1">FACTION</p>
                    <p id="display-faction" class="text-sm">NONE</p>
                </div>
            </div>

            <!-- STATS -->
            <div class="pip-border p-3 bg-black/50">
                <h3 class="text-xs border-b border-pip-green mb-2">C.H.A.P.P.Y. STATS</h3>
                <div id="stats-list" class="text-[10px] space-y-1">
                    <!-- Stats injected -->
                </div>
            </div>
        </div>
    </section>

    <!-- TAB: PERKS -->
    <section id="perks" class="tab-content">
        <div class="pip-border p-4 bg-black/50 space-y-4">
            <h2 class="text-xl border-b border-pip-green mb-4">SPECIAL PERKS</h2>
            
            <!-- ACTIVE PERKS -->
            <div>
                <h3 class="text-xs font-bold text-yellow-500 mb-2">UNLOCKED PERKS</h3>
                <div id="active-perks-list" class="space-y-2">
                    <p class="text-[10px] opacity-70">No perks unlocked yet.</p>
                </div>
            </div>

            <!-- AVAILABLE PERKS -->
            <div>
                <h3 class="text-xs font-bold text-green-400 mb-2">AVAILABLE PERKS</h3>
                <div id="available-perks-list" class="space-y-2">
                    <!-- Available perks injected here -->
                </div>
            </div>
        </div>
    </section>

    <!-- TAB: QUESTS -->
    <section id="quests" class="tab-content">
        <div class="pip-border p-4 bg-black/50">
            <h2 class="text-xl border-b border-pip-green mb-4">ACTIVE CONTRACTS</h2>
            <div id="quests-list" class="space-y-2">
                <!-- Active quests injected here -->
            </div>
        </div>
    </section>

    <!-- TAB: DAILY CHORES -->
    <section id="daily" class="tab-content">
        <div class="pip-border p-4 bg-black/50 space-y-4">
            <h2 class="text-xl border-b border-pip-green mb-4">DAILY CHORES & ACTIVITIES</h2>
            <p class="text-[10px] opacity-70 mb-4">Complete household tasks and activities for small rewards!</p>
            
            <div class="pip-border p-3 border-dashed border-yellow-500 bg-yellow-950/10">
                <h3 class="text-xs font-bold text-yellow-500 mb-3">REQUEST A RANDOM TASK</h3>
                <button onclick="requestRandomQuest()" class="pip-btn w-full py-3 text-sm font-bold">GENERATE TASK</button>
            </div>

            <div id="daily-quest-display" class="hidden">
                <div class="pip-border p-3 bg-green-950/20 border-green-500">
                    <h4 id="daily-quest-title" class="font-bold text-yellow-500 mb-2">TASK TITLE</h4>
                    <p id="daily-quest-desc" class="text-[10px] opacity-80 mb-4">Task description goes here.</p>
                    <div class="flex justify-between items-center mb-2">
                        <p class="text-[10px] text-yellow-500">REWARD:</p>
                        <p id="daily-quest-reward" class="text-lg font-bold text-yellow-500">5 TABS</p>
                    </div>
                    <button onclick="completeRandomQuest()" class="pip-btn w-full py-2 text-sm">COMPLETE TASK</button>
                </div>
            </div>

            <!-- Recent Completions -->
            <div>
                <h3 class="text-xs font-bold text-yellow-500 mb-2">COMPLETED TODAY</h3>
                <div id="daily-completed-list" class="space-y-1 text-[10px]">
                    <p class="opacity-70">No tasks completed yet.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- TAB: CRAFTING -->
    <section id="crafting" class="tab-content">
        <div class="pip-border p-4 bg-black/50 space-y-4">
            <h2 class="text-xl border-b border-pip-green mb-4">INVENTORY & CRAFTING</h2>
            
            <!-- SCRAP MATERIALS -->
            <div>
                <h3 class="text-xs font-bold text-yellow-500 mb-2">SCRAP MATERIALS</h3>
                <div id="scrap-list" class="grid grid-cols-2 gap-2 text-[10px]">
                    <div>Maritime Metal: <span id="scrap-maritimeMetal" class="text-green-400">0</span></div>
                    <div>Synthetic Sap: <span id="scrap-syntheticSap" class="text-green-400">0</span></div>
                    <div>Hub Circuitry: <span id="scrap-hubCircuitry" class="text-green-400">0</span></div>
                    <div>Plaid Scraps: <span id="scrap-plaidScraps" class="text-green-400">0</span></div>
                    <div>Propane Tank: <span id="scrap-propaneTank" class="text-green-400">0</span></div>
                    <div>Rad-Meat: <span id="scrap-radMeat" class="text-green-400">0</span></div>
                    <div>Spices: <span id="scrap-spices" class="text-green-400">0</span></div>
                    <div>Clean Water: <span id="scrap-cleanWater" class="text-green-400">0</span></div>
                </div>
            </div>

            <!-- CRAFTABLE ITEMS -->
            <div>
                <h3 class="text-xs font-bold text-yellow-500 mb-2">NOVA SCOTIA BLUEPRINTS</h3>
                <div id="recipes-list" class="space-y-2 text-[10px]">
                    <div class="border border-pip-green/30 p-2">
                        <p><strong>BLUENOSE BAYONET</strong> (Maritime Metal x2 + Hockey Stick)</p>
                        <p class="opacity-70">Reach weapon, extra damage to Rad-Skeeters</p>
                    </div>
                    <div class="border border-pip-green/30 p-2">
                        <p><strong>TRAPPER'S PLATE</strong> (Maritime Metal x4 + Plaid Scraps x2)</p>
                        <p class="opacity-70">High armor, immune to Red Mud agility penalty</p>
                    </div>
                    <div class="border border-pip-green/30 p-2">
                        <p><strong>PROPANE POPPER</strong> (Propane Tank + Synthetic Sap x2)</p>
                        <p class="opacity-70">Fire AOE grenade, clears swarms</p>
                    </div>
                    <div class="border border-pip-green/30 p-2">
                        <p><strong>DONAIR-DAB KIT</strong> (Rad-Meat + Spices + Clean Water)</p>
                        <p class="opacity-70">Heals 50% HP, +10 RADS (unless LEAD BELLY perk)</p>
                    </div>
                    <div class="border border-pip-green/30 p-2">
                        <p><strong>STIMPAK</strong> (Synthetic Sap x1)</p>
                        <p class="opacity-70">Restores 4 HP</p>
                    </div>
                    <div class="border border-pip-green/30 p-2">
                        <p><strong>RAD-AWAY</strong> (Synthetic Sap x2)</p>
                        <p class="opacity-70">Removes 2 Rads</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- TAB: QUARTERS -->
    <section id="quarters" class="tab-content">
        <div class="pip-border p-4 bg-black/50 space-y-4">
            <h2 class="text-xl border-b border-pip-green mb-4">PERSONAL VAULT - HOME UPGRADES</h2>
            
            <!-- PURCHASED UPGRADES -->
            <div>
                <h3 class="text-xs font-bold text-green-400 mb-2">INSTALLED UPGRADES</h3>
                <div id="quarters-installed" class="space-y-2 text-[10px]">
                    <p class="opacity-70">No upgrades installed yet.</p>
                </div>
            </div>

            <!-- AVAILABLE UPGRADES -->
            <div>
                <h3 class="text-xs font-bold text-yellow-500 mb-2">UPGRADE CATALOG</h3>
                <div id="quarters-available" class="space-y-2 text-[10px]">
                    <!-- Available upgrades inject here -->
                </div>
            </div>
        </div>
    </section>

    <!-- TAB: RADIO -->
    <section id="radio" class="tab-content">
        <div class="pip-border p-4 bg-black/50">
            <h2 class="text-xl border-b border-pip-green mb-4">THREE-CROWS RADIO</h2>
            <div id="radio-broadcast" class="space-y-4">
                <p class="text-[10px] italic opacity-70">WAITING FOR BROADCAST...</p>
            </div>
        </div>
    </section>

    <!-- NOTIFICATION SYSTEM -->
    <div id="toast" class="fixed bottom-6 left-4 right-4 pip-border bg-black p-3 text-sm hidden transform translate-y-full transition-transform duration-300 z-50">
        MESSAGE
    </div>

    <script>
        const API_URL = 'http://localhost:5000';
        let playerName = new URLSearchParams(window.location.search).get('player') || 'logan';
        let playerData = {};
        let allQuests = [];
        let allRadio = [];
        let allPerks = [];
        let allRecipes = [];
        let allQuartersUpgrades = [];
        let playerQuarters = [];

        async function init() {
            document.getElementById('player-name').textContent = playerName.toUpperCase();
            await loadData();
            startPolling();
        }

        async function loadData() {
            try {
                const playerResponse = await fetch(`${API_URL}/api/player/${playerName}`);
                playerData = await playerResponse.json();

                const questsResponse = await fetch(`${API_URL}/api/quests`);
                allQuests = await questsResponse.json();

                const radioResponse = await fetch(`${API_URL}/api/radio`);
                allRadio = await radioResponse.json();

                const perksResponse = await fetch(`${API_URL}/api/perks`);
                allPerks = await perksResponse.json();

                const recipesResponse = await fetch(`${API_URL}/api/recipes`);
                allRecipes = await recipesResponse.json();

                const quartersShopResponse = await fetch(`${API_URL}/api/quarters-shop`);
                allQuartersUpgrades = await quartersShopResponse.json();

                const playerQuartersResponse = await fetch(`${API_URL}/api/player/${playerName}/quarters`);
                playerQuarters = await playerQuartersResponse.json();

                updateUI();
                document.getElementById('sync-status').textContent = '✓ SYNCED';
            } catch (e) {
                console.error('Error loading data:', e);
                document.getElementById('sync-status').textContent = '✗ ERROR';
            }
        }

        function startPolling() {
            // Poll every 2 seconds
            setInterval(loadData, 2000);
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
        }

        function updateUI() {
            // Update header info
            document.getElementById('display-level').textContent = playerData.level || 1;
            document.getElementById('display-class').textContent = playerData.class || 'UNCLASSIFIED';
            document.getElementById('display-tabs').textContent = playerData.tabs || 0;
            document.getElementById('display-faction').textContent = playerData.faction || 'NONE';

            // Update health bars
            const hpPercent = ((playerData.hp || 10) / (playerData.maxHp || 10)) * 100;
            const radPercent = ((playerData.rads || 0) / 10) * 100;
            document.getElementById('hp-bar').style.width = hpPercent + '%';
            document.getElementById('rad-bar').style.width = radPercent + '%';
            document.getElementById('hp-val').textContent = `${playerData.hp || 10}/${playerData.maxHp || 10}`;
            document.getElementById('rad-val').textContent = `${playerData.rads || 0}/10`;

            // Update stats
            const statsList = document.getElementById('stats-list');
            statsList.innerHTML = '';
            if (playerData.stats) {
                for (let stat in playerData.stats) {
                    const val = playerData.stats[stat];
                    const div = document.createElement('div');
                    div.className = 'flex justify-between';
                    div.innerHTML = `<span>${stat}</span><span>${val}</span>`;
                    statsList.appendChild(div);
                }
            }
            // Update quests
            updateQuests();

            // Update scrap
            updateScrap();

            // Update radio
            updateRadio();

            // Update daily completed
            updateDailyCompleted();

            // Update perks
            updatePerks();

            // Update recipes
            updateRecipes();

            // Update quarters
            updateQuarters();
        }

        function updateQuests() {
            const list = document.getElementById('quests-list');
            list.innerHTML = '';
            if (playerData.activeQuests && playerData.activeQuests.length > 0) {
                playerData.activeQuests.forEach(questId => {
                    const quest = allQuests.find(q => q.id === questId);
                    if (quest) {
                        const div = document.createElement('div');
                        div.className = 'quest-card';
                        div.innerHTML = `
                            <h4 class="font-bold text-sm">${quest.title}</h4>
                            <p class="text-[10px] opacity-80 mb-2">${quest.desc}</p>
                            <p class="text-[10px] text-yellow-500">REWARD: ${quest.reward} TABS</p>
                        `;
                        list.appendChild(div);
                    }
                });
            } else {
                list.innerHTML = '<p class="text-[10px] opacity-70">No active quests. Check with the GM.</p>';
            }
        }

        function updateScrap() {
            if (playerData.scrap) {
                for (let item in playerData.scrap) {
                    const span = document.getElementById(`scrap-${item}`);
                    if (span) {
                        span.textContent = playerData.scrap[item];
                    }
                }
            }
        }

        function updateRadio() {
            const broadcast = document.getElementById('radio-broadcast');
            if (playerData.activeRadio) {
                const signal = allRadio.find(r => r.id === playerData.activeRadio);
                if (signal) {
                    broadcast.innerHTML = `
                        <div class="radio-alert">
                            <h3 class="font-bold text-sm mb-2">${signal.title}</h3>
                            <p class="text-[10px] italic leading-relaxed">${signal.text}</p>
                        </div>
                    `;
                    notify(`RADIO SIGNAL: ${signal.title}`);
                }
            }
        }

        function updateRecipes() {
            const list = document.getElementById('recipes-list');
            list.innerHTML = '';
            if (allRecipes && allRecipes.length > 0) {
                allRecipes.forEach(recipe => {
                    const div = document.createElement('div');
                    div.className = 'border border-pip-green/30 p-2';
                    
                    // Build ingredient text
                    let ingredientText = '';
                    if (recipe.ingredients && recipe.ingredients.length > 0) {
                        ingredientText = recipe.ingredients
                            .map(ing => `${ing.type} x${ing.amount}`)
                            .join(' + ');
                    }
                    
                    const canCraft = recipe.ingredients.every(ing => {
                        if (ing.type === 'propaneTank' || ing.type === 'syntheticSap' || 
                            ing.type === 'maritimeMetal' || ing.type === 'plaidScraps' ||
                            ing.type === 'radMeat' || ing.type === 'spices' || 
                            ing.type === 'cleanWater' || ing.type === 'hubCircuitry') {
                            const scrap = playerData.scrap || {};
                            return scrap[ing.type] && scrap[ing.type] >= ing.amount;
                        }
                        return true;
                    });
                    
                    const craftBtn = canCraft 
                        ? `<button onclick="craft('${recipe.id}')" class="pip-btn text-[9px] w-full mt-2">CRAFT</button>`
                        : `<button disabled class="pip-btn text-[9px] w-full mt-2 opacity-40 cursor-not-allowed">CRAFT</button>`;
                    
                    div.innerHTML = `
                        <p><strong>${recipe.name}</strong></p>
                        <p class="text-[9px] opacity-70 mb-1">${ingredientText}</p>
                        <p class="opacity-70 text-[9px]">${recipe.desc}</p>
                        ${craftBtn}
                    `;
                    list.appendChild(div);
                });
            }
        }

        async function craft(recipeId) {
            try {
                const response = await fetch(`${API_URL}/api/player/${playerName}/craft/${recipeId}`, {
                    method: 'POST'
                });
                const result = await response.json();
                if (response.ok) {
                    notify(`SUCCESS: ${result.message}`);
                    await loadData();
                } else {
                    notify(`ERROR: ${result.error}`);
                }
            } catch (e) {
                console.error('Craft error:', e);
                notify('CRAFT FAILED');
            }
        }

        function notify(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.remove('hidden');
            toast.classList.remove('translate-y-full');
            setTimeout(() => {
                toast.classList.add('translate-y-full');
                setTimeout(() => toast.classList.add('hidden'), 300);
            }, 3000);
        }

        let currentRandomQuest = null;

        async function requestRandomQuest() {
            try {
                const response = await fetch(`${API_URL}/api/random-quest`);
                currentRandomQuest = await response.json();
                
                // Display the quest
                document.getElementById('daily-quest-title').textContent = currentRandomQuest.title;
                document.getElementById('daily-quest-desc').textContent = currentRandomQuest.desc;
                document.getElementById('daily-quest-reward').textContent = `${currentRandomQuest.reward} TABS`;
                document.getElementById('daily-quest-display').classList.remove('hidden');
                
                notify(`NEW TASK: ${currentRandomQuest.title}`);
            } catch (e) {
                console.error('Error requesting random quest:', e);
                notify('ERROR: Could not generate task');
            }
        }

        async function completeRandomQuest() {
            if (!currentRandomQuest) {
                notify('No active task.');
                return;
            }

            try {
                // Award tabs and add to completed list
                playerData.tabs += currentRandomQuest.reward;
                
                // Add to session completed quests
                if (!playerData.dailyCompleted) {
                    playerData.dailyCompleted = [];
                }
                playerData.dailyCompleted.push({
                    title: currentRandomQuest.title,
                    reward: currentRandomQuest.reward,
                    time: new Date().toLocaleTimeString()
                });

                notify(`TASK COMPLETE! +${currentRandomQuest.reward} TABS`);
                
                // Hide quest and reset
                document.getElementById('daily-quest-display').classList.add('hidden');
                updateDailyCompleted();
                updateUI();
                
                currentRandomQuest = null;
            } catch (e) {
                console.error('Error completing quest:', e);
                notify('ERROR: Could not complete task');
            }
        }

        function updateDailyCompleted() {
            const list = document.getElementById('daily-completed-list');
            if (playerData.dailyCompleted && playerData.dailyCompleted.length > 0) {
                list.innerHTML = '';
                playerData.dailyCompleted.forEach(quest => {
                    const div = document.createElement('div');
                    div.className = 'border-l-2 border-yellow-500 pl-2 text-yellow-500';
                    div.innerHTML = `
                        <span class="font-bold">${quest.title}</span> - +${quest.reward} TABS<br>
                        <span class="text-[8px] opacity-70">${quest.time}</span>
                    `;
                    list.appendChild(div);
                });
            }
        }

        function updatePerks() {
            const activeList = document.getElementById('active-perks-list');
            const availableList = document.getElementById('available-perks-list');
            
            activeList.innerHTML = '';
            availableList.innerHTML = '';

            if (playerData.unlockedPerks && playerData.unlockedPerks.length > 0) {
                const unlockedPerks = playerData.unlockedPerks
                    .map(perkId => allPerks.find(p => p.id === perkId))
                    .filter(p => p);
                
                unlockedPerks.forEach(perk => {
                    const div = document.createElement('div');
                    div.className = 'border-2 border-green-500 bg-green-950/20 p-2';
                    div.innerHTML = `
                        <h4 class="font-bold text-green-400">${perk.name}</h4>
                        <p class="text-[10px] opacity-80">${perk.desc}</p>
                    `;
                    activeList.appendChild(div);
                });
            } else {
                activeList.innerHTML = '<p class="text-[10px] opacity-70">No perks unlocked yet.</p>';
            }

            // Show available perks player can choose
            if (allPerks && allPerks.length > 0) {
                const lockedPerks = allPerks.filter(p => !playerData.unlockedPerks || !playerData.unlockedPerks.includes(p.id));
                
                if (lockedPerks.length > 0) {
                    lockedPerks.forEach(perk => {
                        const div = document.createElement('div');
                        div.className = 'border border-pip-green/30 p-2 cursor-pointer hover:border-pip-green transition';
                        div.innerHTML = `
                            <h4 class="font-bold text-sm">${perk.name}</h4>
                            <p class="text-[10px] opacity-80 mb-2">${perk.desc}</p>
                            <button onclick="selectPerk('${perk.id}')" class="pip-btn text-[8px] w-full">SELECT PERK</button>
                        `;
                        availableList.appendChild(div);
                    });
                } else {
                    availableList.innerHTML = '<p class="text-[10px] opacity-70">All available perks are unlocked!</p>';
                }
            }
        }

        function updateQuarters() {
            const installedList = document.getElementById('quarters-installed');
            const availableList = document.getElementById('quarters-available');
            
            installedList.innerHTML = '';
            availableList.innerHTML = '';

            // Show installed upgrades
            if (playerData.purchasedUpgrades && playerData.purchasedUpgrades.length > 0) {
                const installed = playerData.purchasedUpgrades
                    .map(upgradeId => allQuartersUpgrades.find(u => u.id === upgradeId))
                    .filter(u => u);
                
                installed.forEach(upgrade => {
                    const div = document.createElement('div');
                    div.className = 'border-2 border-green-500 bg-green-950/20 p-2';
                    div.innerHTML = `
                        <h4 class="font-bold text-green-400">${upgrade.name}</h4>
                        <p class="text-[10px] opacity-80">${upgrade.effect}</p>
                    `;
                    installedList.appendChild(div);
                });
            } else {
                installedList.innerHTML = '<p class="text-[10px] opacity-70">No upgrades installed yet.</p>';
            }

            // Show available upgrades for purchase
            if (allQuartersUpgrades && allQuartersUpgrades.length > 0) {
                const available = allQuartersUpgrades.filter(u => !playerData.purchasedUpgrades || !playerData.purchasedUpgrades.includes(u.id));
                
                if (available.length > 0) {
                    available.forEach(upgrade => {
                        const canAfford = playerData.tabs >= upgrade.cost;
                        const div = document.createElement('div');
                        div.className = canAfford ? 'border border-yellow-500/50 p-2 cursor-pointer hover:border-yellow-500 transition' : 'border border-red-500/30 p-2 opacity-60';
                        div.innerHTML = `
                            <h4 class="font-bold text-yellow-500">${upgrade.name}</h4>
                            <p class="text-[10px] opacity-80 mb-1">${upgrade.desc}</p>
                            <p class="text-[9px] text-yellow-600 mb-2">COST: ${upgrade.cost} TABS</p>
                            <button onclick="purchaseQuartersUpgrade('${upgrade.id}')" class="pip-btn text-[8px] w-full ${!canAfford ? 'opacity-50 cursor-not-allowed' : ''}" ${!canAfford ? 'disabled' : ''}>BUY UPGRADE</button>
                        `;
                        availableList.appendChild(div);
                    });
                } else {
                    availableList.innerHTML = '<p class="text-[10px] opacity-70">All available upgrades are installed!</p>';
                }
            }
        }

        async function selectPerk(perkId) {
            try {
                const response = await fetch(`${API_URL}/api/player/${playerName}/perk/${perkId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (response.ok) {
                    await loadData();
                    notify('Perk selected!');
                } else {
                    notify('Could not select perk');
                }
            } catch (e) {
                console.error('Error selecting perk:', e);
                notify('ERROR: Could not select perk');
            }
        }

        function updateQuarters() {
            const installedDiv = document.getElementById('quarters-installed');
            const availableDiv = document.getElementById('quarters-available');
            
            // Show installed upgrades
            if (playerQuarters && playerQuarters.length > 0) {
                installedDiv.innerHTML = '';
                playerQuarters.forEach(upgrade => {
                    const upgradeEl = document.createElement('div');
                    upgradeEl.className = 'border border-green-400 bg-green-400/5 p-2';
                    upgradeEl.innerHTML = `
                        <p class="font-bold text-green-400">${upgrade.name}</p>
                        <p class="opacity-70 text-[9px]">${upgrade.desc}</p>
                        <p class="text-[9px] text-green-300 italic mt-1">${upgrade.effect}</p>
                    `;
                    installedDiv.appendChild(upgradeEl);
                });
            } else {
                installedDiv.innerHTML = '<p class="opacity-70">No upgrades installed yet.</p>';
            }
            
            // Show available upgrades
            const available = allQuartersUpgrades.filter(u => !playerQuarters.some(p => p.id === u.id));
            if (available.length > 0) {
                availableDiv.innerHTML = '';
                available.forEach(upgrade => {
                    const canAfford = playerData.tabs >= upgrade.cost;
                    const upgradeEl = document.createElement('div');
                    upgradeEl.className = `border ${canAfford ? 'border-pip-green' : 'border-red-600'} p-2`;
                    upgradeEl.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-bold">${upgrade.name}</p>
                                <p class="opacity-70 text-[9px]">${upgrade.desc}</p>
                                <p class="text-[9px] text-yellow-500 font-bold mt-1">COST: ${upgrade.cost} TABS</p>
                            </div>
                            <button onclick="purchaseUpgrade('${upgrade.id}')" class="pip-btn text-[8px] p-1 ${canAfford ? '' : 'opacity-50 cursor-not-allowed'}" ${!canAfford ? 'disabled' : ''}>BUY</button>
                        </div>
                    `;
                    availableDiv.appendChild(upgradeEl);
                });
            } else {
                availableDiv.innerHTML = '<p class="opacity-70">All upgrades purchased!</p>';
            }
        }

        async function purchaseUpgrade(upgradeId) {
            try {
                const response = await fetch(`${API_URL}/api/player/${playerName}/quarters/${upgradeId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                
                if (response.ok) {
                    await loadData();
                    notify(`Purchased: ${result.upgrade.name}!`);
                } else {
                    notify(`ERROR: ${result.error}`);
                }
            } catch (e) {
                console.error('Error purchasing upgrade:', e);
                notify('ERROR: Could not purchase upgrade');
            }
        }

        async function purchaseQuartersUpgrade(upgradeId) {
            try {
                const response = await fetch(`${API_URL}/api/player/${playerName}/quarters/${upgradeId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (response.ok) {
                    const result = await response.json();
                    await loadData();
                    notify(`Installed: ${result.upgrade.name}`);
                } else {
                    const result = await response.json();
                    notify(`ERROR: ${result.error}`);
                }
            } catch (e) {
                console.error('Error purchasing upgrade:', e);
                notify('ERROR: Could not purchase upgrade');
            }
        }

        window.onload = init;
    </script>
</body>
</html>
